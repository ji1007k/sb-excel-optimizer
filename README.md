# **Excel 대용량 다운로드 최적화 프로젝트**

> 이 프로젝트는 실무에서 겪었던 OOM 문제를 해결한 것에서 나아가, 동시성 제어를 통해 시스템을 최적화한 과정을 담고 있습니다.

---

### **프로젝트 개요**
* **배경**: 이전 회사에서 엑셀 다운로드 기능 시연 중, **대용량 데이터(10만 건)** **동시 요청**으로 **OutOfMemoryError(OOM)**가 발생했습니다. 이는 서비스 중단 및 파일 손상으로 이어지는 치명적인 문제였습니다.
* **문제 분석**: 대용량 데이터를 메모리에 한꺼번에 로딩하는 **전체 로딩 방식**이 주 원인이었습니다. 이 방식은 단일 요청에서도 메모리 부족을 유발할 수 있지만, 이전까지는 4GB 힙 메모리와 내부 시스템 특성상 사용자가 많지 않아 문제가 드러나지 않았습니다.
* **목표**: **동시성 제어**를 통해 **대용량 엑셀 다운로드 성능과 안정성을 최적화**하고자 했습니다.

---

### **개선 과정**

#### **1차: 실무 조치 사항 (OOM 해결)**
* **목표**: 서비스 중단의 주원인인 OOM 문제 해결 및 안정성 확보.
* **문제점**: 대량 데이터를 한꺼번에 메모리에 로딩하는 방식.
* **조치**: `XSSF + 전체 SELECT` → `SXSSF + 1000건 페이징`으로 변경하여 메모리 사용량을 획기적으로 줄였습니다.
* **결과**: 4GB 힙 메모리 환경에서 20건의 동시 요청까지 OOM 없이 처리하는 안정성을 확보했습니다.

#### **2차: 심화 최적화 (성능 및 동시성 개선)**
* **목표**: 1차 조치 이후 드러난 병목 현상을 해결하고, 서비스 확장성과 동시성 처리량 극대화.
* **조치**:
    1.  **DB 쿼리 성능 개선**: 1차 조치에서 사용한 ROWNUM 방식의 한계를 극복하기 위해 **ID 기반 커서 페이징**을 적용하여 인덱스를 활용한 쿼리 최적화를 통해 데이터 조회 성능을 향상시켰습니다.
    2.  **동시성 제어 아키텍처 도입**: 최대 3건의 동시 처리가 가능하도록 구현했으며, 대량의 요청이 몰릴 경우를 대비해 **BlockingQueue** 기반의 **백프레셔(Backpressure)** 아키텍처를 도입했습니다. 이를 통해 시스템 리소스를 보호하고, 사용자에게 즉시 응답을 제공하여 병목 현상을 해소하고 사용자 경험을 혁신했습니다.
* **결과**: 분당 처리량 6배 향상 및 즉시 응답으로 사용자 경험을 개선했습니다.

---

### **📈 성능 개선 핵심 요약**

| 측정 항목 | **전체 로딩** | **분할 처리** | **비동기 큐**  |
|:---:|:---------:|:---:|:----------:|
| **응답시간** |    OOM    | 7분 5초 | **즉시 응답**  |
| **실제 처리시간** |   불가    | 7분 5초 | **2분 23초** |
| **메모리 사용량** |    OOM    | 72MB |  **32MB**  |
| **분당 처리량** |    0개     | 0.1개 |  **0.6개**  |

> [성능 개선 상세 결과 보기](./docs/performance-test-results.md)

---

### **아키텍처 및 기술 스택**
* **기술 스택**: Java 17, Spring Boot 3.2, PostgreSQL
* **주요 기술**:
    * **동시성 제어**: `BlockingQueue`를 활용한 `ThreadPoolExecutor` 기반 동시성 제어 아키텍처.
    * **데이터베이스**: ID 기반 커서 페이징 쿼리 (`ORDER BY id LIMIT ?`).
    * **패턴**: `전략 패턴(Strategy Pattern)`을 적용하여 다양한 엑셀 생성 방식을 유연하게 교체할 수 있도록 설계.
    * **라이브러리**: Apache POI (SXSSF).

---

### **주요 학습 및 성과**
1.  **실무 문제 해결 경험**: 실제 운영 환경에서 발생한 문제를 분석하고, 단계적인 접근으로 안정성을 확보한 후 성능을 최적화한 경험.
2.  **메모리 관리**: JVM 힙 메모리 및 GC 동작 원리 이해를 통해, OOM의 근본 원인인 비효율적 메모리 사용을 성공적으로 해결했습니다.
3.  **동시성 제어**: **백프레셔** 구현을 통해 시스템 리소스를 보호하고, 대량의 요청에도 안정적으로 대응할 수 있는 아키텍처 설계 역량을 갖추게 되었습니다.
4.  **비즈니스 임팩트**:
    * **서비스 안정성**: OOM으로 인한 서버 다운 위험을 효과적으로 제거했습니다.
    * **사용자 경험 혁신**: 수 분을 기다려야 했던 다운로드 요청을 즉시 응답으로 개선했습니다.
    * **운영 효율성**: 동일한 하드웨어에서 6배 이상 향상된 처리량으로 운영 비용을 절감했습니다.

---

### **향후 개선 계획**
1.  **라이브러리 교체**: Apache POI를 **FastExcel**로 교체하여 더 높은 메모리 효율성과 쓰기 성능을 확보할 예정입니다.
2.  **큐 영속성 확보 및 다중 서버 환경 대비**: BlockingQueue의 인메모리 한계를 인지하고 있으며, 큐 영속성 확보 및 다중 서버 환경에서의 확장을 위해 Redis/RabbitMQ와 같은 외부 메시지 큐 도입을 고려하고 있습니다.

---

